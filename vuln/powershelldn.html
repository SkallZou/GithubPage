<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>PowerShell & .NET</title>
        <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v5.15.1/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:500,700" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Muli:400,400i,800,800i" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="../css/styles.css" rel="stylesheet" />
    </head>
    <body id="page-top">
        <!-- Navigation-->
        <nav class="navbar navbar-expand-xl navbar-dark bg-primary fixed-top" id="sideNav">
            <a class="navbar-brand js-scroll-trigger" href="../index.html">
                <span class="d-block d-xl-none">Olivier LEUNG</span>
                <span class="d-none d-xl-block"><img class="img-fluid img-profile rounded-circle mx-auto mb-2" src="../assets/img/profile.jpg" alt="" /></span>
            </a>
            <div class="d-none d-xl-block description_profile"> <!--d-none is used for responsiveness of the panel when you shring the window -->
                <h3>Olivier LEUNG</h3>
                <div class="subheading_panel">Cybersecurity engineer </div>
                    <div class="subheading_description">Love testing random cyber stuff !<br>That's by baking we become a baker</div>
            </div>
            <!-- button collapse panel when small windows, responsive pane -->
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button> 
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="../ctfpage.html">CTF</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="../dfirpage.html">DFIR</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="../vulnpage.html">Vuln Exploitation</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="../reversepage.html">Reverse Engineering</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="../tutorialpage.html">Tutorial</a></li>
                </ul>
            </div>

            <div class="d-none d-xl-block social-icons">
                <a class="social-icon" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/olivierleung"><i class="fab fa-linkedin-in"></i></a>
                <a class="social-icon" target="_blank" rel="noopener noreferrer" href="https://github.com/SkallZou"><i class="fab fa-github"></i></a>
                <a class="social-icon" target="_blank" rel="noopener noreferrer" href="https://twitter.com/olivier_leung"><i class="fab fa-twitter"></i></a>
            </div>
        <footer class="d-none d-xl-block">
            <div class="container">
              <p class="m-0 text-center footerpage">Copyright &copy; 2020 Olivier Leung<br>All rights reserved.</p>
            </div>
        </footer>
        </nav>
        <!-- Page Content-->
        <div>
            <nav class="navbar navbar-expand-xl navbar-dark bg-secondary sticky-top">
            <h3 class="header-article"><a href="../vulnpage.html">Vulnerability Exploitation </a>> PowerShell & .NET</h3>
            </nav>
            
            <section class="article">
                <div class="d-flex flex-column flex-md-row justify-content-between mb-5">
                    <div class="flex-grow-1">
                        <h3 class="mb-0">Introduction</h3>
                        <p>
                            After getting several alerts from FireEye regarding suspicious .dll file coming from the process csc.exe, I decided dig into that subject. After doing an Enterprise Search in FireEye for the process name "csc.exe", I've found that PowerShell.exe is often the parent process of csc.exe. According to some researches, by dynamically compiling a C# code through PowerShell, it can also be used to evade detection.  For instance, compiling malware this way can evade Symantec’s “reputation 1” detection of new and untrusted softwares. It also has been seen that it can evade detection from Device Guard since Code Integrity is not performed. <br>
                            <br>
                            This article is to understand how can we exploit that vulnerability and to discover FireEye rule logic for when csc.exe use is “normal” and when it is an attack.
                        </p>
                    </div>
                </div>
            </section>
            <section class="article">
                <div class="d-flex flex-column flex-md-row justify-content-between mb-5">
                    <div class="flex-grow-1">
                        <h3 class="mb-0">What is csc.exe ?</h3>
                        <p>
                            The process <strong>Csc.exe</strong> is a C# compiler and is part of Microsoft .NET Framework. A compiler is used to translate a programming language (high-level language understood by human) into machine code (machine code or assembly). We can invoke the C# compiler by typing csc.exe at a command prompt. <br>
                            The default location of csc.exe is "C:\Windows\Microsoft.NET\Framework\<<i>Version</i>>", the version of the framework for Microsoft.NET might vary. To know the location of csc.exe, you can type this command in the windows command line: 
                            <div class="squarebox">dir /s %WINDIR%\csc.exe</div>
                            <img src="img/PowerShell .NET/csclocation.png" class="img-fluid" width="400">
                            In the case where csc.exe is located in C:\Windows or in C:\Windows\System32, an investigation will be necessary. A potential malicious csc.exe is present. Many malwares try to dissimulate itself by having the same name as a legitimate program. 
                        </p>
                    </div>
                </div>
            </section>
            <section class="article">
                <div class="d-flex flex-column flex-md-row justify-content-between mb-5">
                    <div class="flex-grow-1">
                        <h3 class="mb-0">Compiling C# with PowerShell</h3>
                        <p>
                            In PowerShell, when the cmdlet “<strong>Add-type</strong>>” is executed, it will run the csc.exe to compile the C# code into an machine language. A temporary file <i>XXXX.cmdline</i> is created in AppData\local\temp and this file will be passed as argument to the C# compiler csc.exe to reate XXXX.0.cs in AppData\local\temp. <br>
                            <br>
                            <strong>Device Guard</strong> is a functionality developed by Microsoft, available only on <i>Windows 10 Enterprise</i>. It allows to lock any device to only run signed and allowed applications and scripts. Device Guard uses a technology called "<strong>Code Integrity</strong>” which will verify the integrity of the Windows kernel before running any script. Therefore, it become harder to run a malicious code because it might be blocked by Device Guard. The Code Integrity is based on the virtualization and when the system is booting, Hyper-V Code Integrity verifies that every script and driver running on the system are signed. <br>
                            However, by compiling C# with PowerShell, the Code Integrity checks are not performed on any code that compiles C# dynamically with csc.exe. <br>
                            <br>
                            <u>What does dynamically compile means?</u><br>
                            Delaying compilation of a program, it can be done at program load, or on demand as code is executed. During execution, the program may be compiled into native code to improve its performance.




                        </p>
                    </div>
                </div>
            </section>
            <section class="article">
                <div class="d-flex flex-column flex-md-row justify-content-between mb-5">
                    <div class="flex-grow-1">
                        <h3 class="mb-0">POC: Analyzing PowerShell calling csc.exe</h3>
                        <p>
                        </p>
                        <br>
                    </div>
                </div>
            </section>
        </div>
        <!-- Bootstrap core JS-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Third party plugin JS-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
    </body>
</html>
