<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Emprisa Maldoc</title>
        <link rel="icon" type="image/x-icon" href="../assets/img/favicon.ico" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v5.15.1/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:500,700" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Muli:400,400i,800,800i" rel="stylesheet" type="text/css"/>
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="../css/styles.css" rel="stylesheet" />
    </head>
    <body id="page-top">
        <!-- Navigation-->
        <nav class="navbar navbar-expand-xl navbar-dark bg-primary fixed-top" id="sideNav">
            <a class="navbar-brand js-scroll-trigger" href="../index.html">
                <span class="d-block d-xl-none">Olivier LEUNG</span>
                <span class="d-none d-xl-block"><img class="img-fluid img-profile rounded-circle mx-auto mb-2" src="../assets/img/profile.jpg" alt="" /></span>
            </a>
            <div class="d-none d-xl-block description_profile"> <!--d-none is used for responsiveness of the panel when you shring the window -->
                <h3>Olivier LEUNG</h3>
                <div class="subheading_panel">Cybersecurity engineer </div>
                    <div class="subheading_description">Love testing random cyber stuff !<br>That's by baking we become a baker</div>
            </div>
            <!-- button collapse panel when small windows, responsive pane -->
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button> 
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="../ctfpage.html">CTF</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="../dfirpage.html">DFIR</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="../vulnpage.html">Vuln Exploitation</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="../malwarepage.html">Malware Analysis</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="../tutorialpage.html">Tutorial</a></li>
                </ul>
            </div>

            <div class="d-none d-xl-block social-icons"> <!--d-none d-xl-block not appear in mobile [responsive] -->
                <a class="social-icon" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/olivierleung"><i class="fab fa-linkedin-in"></i></a>
                <a class="social-icon" target="_blank" rel="noopener noreferrer" href="https://github.com/SkallZou"><i class="fab fa-github"></i></a>
                <a class="social-icon" target="_blank" rel="noopener noreferrer" href="https://twitter.com/olivier_leung"><i class="fab fa-twitter"></i></a>
            </div>
        <footer class="d-none d-xl-block">
            <div class="container">
              <p class="m-1 text-center footerpage">Copyright &copy; 2021 Olivier Leung<br>All rights reserved.</p>
            </div>
        </footer>
        </nav>
        <!-- Page Content-->
        <div>
            <nav class="navbar navbar-expand-xl navbar-dark bg-header sticky-top">
            <h3 class="header-article"><a href="../malwarepage.html">Malware Analysis </a>> Cyberdefenders - Emprisa Maldoc</h3>
            </nav>
            <section class="article">
                <div class="d-flex flex-column flex-md-row justify-content-between mb-5">
                    <div class="flex-grow-1">
                        <p>

                            As a SOC analyst, a suspicious document is received by a user. One of your colleagues told you that he could not find anything suspicious. However, throwing the document into the sandboxing solution triggered some alerts. The goal is to investigate the document further and confirm whether it's malicious or not.
                           <br><br>
                           The malware is based on the CVE-2017-11882. The vulnerability affect several versions of Microsoft Office product. The adversary can exploit this vulnerability and perform a remote code execution and retrieve the same permission as the current logged user. The vulnerability is found on the process  “EQNEDT32.exe », this process is used to calculate some numbers in Microsoft Office Documents, however this process does not check the length of the number, which leads to a potential buffer overflow. Moreover, this process uses a old compiler that is not compatible with the ASLR (Address Space Layout Randomization) that randomize the memory address and it is a protection against buffer overflow exploit. By exploiting the buffer overflow vulnerability, the attacker can remotely execute remotely some malicious commands. <br>
                           <br>
                           The attack comes from a .rtf file which overwrite a memory address by exploiting the vulnerability CVE-2017-11882 to call WinExec() from kernel32.dll. WinExec() will run the program passed as an argument. Mshta() is passed as an argument and will download a file from a domain. Mshta() can be used to bypass application whitelisting defenses and browser security settings since it is a signed and native Microsoft binary that exists on Windows to execute code in different ways. It can execute a remote file by passing a .hta file as an argument. Those .hta files are HTML applications and can run JavaScript or VBScript. <br>
                           <br>
                           <a href="https://github.com/DidierStevens/DidierStevensSuite/blob/master/rtfdump.py">Rtfdump.py</a> is a tool written by Didier Stevens to perform analysis on .rtf files. A .rtf file is a Rich Text Format file, it is similar as a plain text file but with the possibility to write in bold and italic, managing the font size and adding images.
                           <br><br>

                           <h3 class="mb-0 header-article">Static Analysis</h3>
                           <img src="img/emprisa/rtfdump_1.jpg" class="img-fluid" width="900">
                           Rtfdump.py helps us to retrieve objects from the rtf file. In the case where the attacker has tried to obfuscate the content of the .rtf file, the content will probably be bigger and more complicated to read. To only filter entries that potentially contain an embedded object, use the option <strong>-f O</strong>.

                           <div class="squarebox">rtfdump.py -f O %FILENAME%</div>
                           <img src="img/emprisa/rtfdump_option.jpg" class="img-fluid" width="900">
                           So we found 1 entry that seems to contain an embedded object, the name is “Equation.3” with the magic signature “d0cf11e0”. The magic byte “D0 CF 11 E0” indicates a Microsoft Office document.
                           Here are the meanings of the different parameters :
                            <ul>
                                <li>c = number of child process</li>
                                <li>p = position of the file, here it is f3</li>
                                <li>l = length of the file (7268 byte long)</li>
                                <li>h = 7254 hexadecimal digits</li>
                                <li>b = binary entry, 0 indicates that there is no binary entry</li>
                                <li>u = number of unknown characters</li>
                            </ul>
                            To select the entry, use the parameter “s”. In our case, we are interested in the 7th entry of the list.
                            <div class="squarebox">rtfdump.py -s 7 %FILENAME%</div>
                            <img src="img/emprisa/rtfdump_select.jpg" class="img-fluid" width="800">                                             
                            However the content is in hexadecimal, use the option H to decode the hexadecimal data. Then, we will be able look at the strings of the file by using the parameter “-d” to dump the file.
                            <div class="squarebox">rtfdump.py c39-EmprisaMaldoc.rtf -s7 -H -d > EmprisaMaldoc.bin <br>strings EmprisaMaldoc.bin</div>
                            <img src="img/emprisa/strings.jpg" class="img-fluid" width="800"> 
                            Looking at the strings, we see several things that might interest us. There might be a potential .exe file “Qh.exe” and a suspicious path “C:\oSRQharyAhLibrhLoadTS”. <br>
                            Looking at the hexdump, we notice that there are a lot of NOP “\x90”, it is usually to tell the program to do nothing, and also might be a indication of a shellcode. Therefore, we will dump this part of the program. The parameter <strong>-c</strong> of rtfdump.py allows us to cut a part of the shellcode.
                            Take the address of the first NOP, which is 0x961.
                            <img src="img/emprisa/hexdump_1.jpg" class="img-fluid" width="800">
                            The end address is 0xD16 (until .png) 
                            <img src="img/emprisa/hexdump_2.jpg" class="img-fluid" width="800"> 
                            <div class="squarebox">rtfdump.py c39-EmprisaMaldoc.rtf -s7 -H -c 0x961:0xD16 -d > maldoc.sc</div>
                            <a href="https://github.com/fireeye/speakeasy">Speakeasy</a> from FireEye can translate the hex into shellcode instruction.
                            <img src="img/emprisa/speakeasy.jpg" class="img-fluid" width="800">
                            However, it seems that the shellcode is not readable. There is a problem at the address 401017 with the value 00 00. Looking at the hexdump, there is a “14 21 40 00 00 00” at the address of 0x975 that makes an error when putting the hexdump in scdgb. Let’s take the address of the first NOP after the last “00”, which is 0x97B.
                            <div class="squarebox">rtfdump.py c39-EmprisaMaldoc.rtf -s7 -H -c 0x97B:0xD17 -d > maldoc.sc</div>
                            <img src="img/emprisa/speakeasy_2.jpg" class="img-fluid" width="800">
                            Now, at least we’ve got a kernel32.GetProcAddress() followed by an error.
                            <br>
                            It seems that there is a problem in the shellcode, some value are blocking the shellcode to run correctly. Looking at the hexdump, we have two block of hex and in the middle full of 00 and FF.
                            <div class="squarebox">\0x00 : NullByte <br>\0xFF : Page Break</div>
                            I’ve decided to remove all the second part of the hexdump. We still get the same result, kernel32.GetProcessAddress() followed by the error, therefore the instruction GetProcessAddress() does not need the second part of the hexdump. Then I decided to remove the string “Equation Native” and it also does not seem to be important in the instruction. <br>
                            <br>
                            Removing until 0xA19, generate immediately an error, kernel32.GetProcAddress() wasn’t displayed anymore. So I decided to dump the hexcode until we reach the string “Equation Native”, which means from the address \0x97B to \0xA22.
                            <div class="squarebox">rtfdump.py c39-EmprisaMaldoc.rtf -s 7 -H -c 0x97B:0xA22 -d > maldoc.sc</div>
                            Looking at the hexdump, we don’t need to copy the 00 since it is a NULL meaning. So let’s start by dumping the hexcode from the address 0x23
                            <img src="img/emprisa/hexdump_3.jpg" class="img-fluid" width="800"> 
                            <div class="squarebox">rtfdump.py c39-EmprisaMaldoc.rtf -s 7 -H -c 0xC23:0xD16 -d > maldoc2.sc</div>
                            I’ve created a script “copy.sh” to make my task easier : 
                            <div class="squarebox">#!/bin/bash <br>
                            cat maldoctest.sc > maldoc.sc; <br>
                            cat maldoctest2.sc >> maldoc.sc; <br>
                            python3 ~/tools/speakeasy/run_speakeasy.py -t ~/cyberdefenders/Emprisa/c39-EmprisaMaldoc/maldoc.sc -a x86 -r
                            </div>
                            <img src="img/emprisa/speakeasy_3.jpg" class="img-fluid" width="800">
                            Finally, we managed to have the complete shellcode without having an error, those instructions gives you quite a lot a interesting elements. After the kernel32.GetProcessAddress(), the program is loading the library “urlmon.dll” to call the function URLDownloadToFileA(). The URL “https://raw.githubusercontent.com/accidentalrebel/accidentalrebel.com/gh-pages/theme/images/test.png” is passed as an argument to this function. <br>
                            Test.png which is downloaded from the URL is saved in the following path: C:\O.exe, then WinExec() is called to execute the downloaded program “O.exe”.
                            <br><br>    
                            
                            <h3 class="mb-0 header-article">Dynamic Analysis</h3>
                            Let's run the malicious rtf file in a sandbox and see what we've got.
                            <img src="img/emprisa/sandbox1.jpg" class="img-fluid" width="700">
                            <img src="img/emprisa/sandbox2.jpg" class="img-fluid" width="700">
                            Running the file open a message bloc with "Congratulations ! flag{cotizacin}". Another executable file has also been launched "C:\O.exe". Looking at the network communication, we see that the system has communicated with the domain "raw.githubusercontent.com" and the IP address "185.199.108.133" from the process <strong>eqnedt32.exe</strong>
                            <br>
                            <br>
                            <h3 class="mb-0 header-article">Conclusion</h3>
                            By analyzing the .rtf file with rtfdump.py from Didier Stevens, we managed to deobfuscate the content of a object of a .rtf file. Having noticed some signs of a potential shellcode due to the number of "NOP" instructions, we managed to reconstruct entirely the shellcode by copying 2 parts of the hexdump and removing the useless parts from the hexdump. The most difficult part of this challenge is to reconstruct the shellcode, because the shellcode makes you understand what this malicious .rtf file is doing. It will first load the dll "urlmon.dll" used to download a file by calling the function <strong>URLDownloadToFileA</strong> and execute the downloaded file "C:\o.exe". 
                        </p>
                    </div>
                </div>
            </section>
        </div>
        <script src="../js/lightbox.js"></script>
        <!-- Bootstrap core JS-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Third party plugin JS-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
    </body>
</html>
