<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Banking Troubles</title>
        <link rel="icon" type="image/x-icon" href="../assets/img/favicon.ico" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v5.15.1/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:500,700" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Muli:400,400i,800,800i" rel="stylesheet" type="text/css"/>
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="../css/styles.css" rel="stylesheet" />
    </head>
    <body id="page-top">
        <!-- Navigation-->
        <nav class="navbar navbar-expand-xl navbar-dark bg-primary fixed-top" id="sideNav">
            <a class="navbar-brand js-scroll-trigger" href="../index.html">
                <span class="d-block d-xl-none">Olivier LEUNG</span>
                <span class="d-none d-xl-block"><img class="img-fluid img-profile rounded-circle mx-auto mb-2" src="../assets/img/profile.jpg" alt="" /></span>
            </a>
            <div class="d-none d-xl-block description_profile"> <!--d-none is used for responsiveness of the panel when you shring the window -->
                <h3>Olivier LEUNG</h3>
                <div class="subheading_panel">Cybersecurity engineer </div>
                    <div class="subheading_description">Love testing random cyber stuff !<br>That's by baking we become a baker</div>
            </div>
            <!-- button collapse panel when small windows, responsive pane -->
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button> 
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="../ctfpage.html">CTF</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="../dfirpage.html">DFIR</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="../vulnpage.html">Vuln Exploitation</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="../malwarepage.html">Malware Analysis</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="../tutorialpage.html">Tutorial</a></li>
                </ul>
            </div>

            <div class="d-none d-xl-block social-icons"> <!--d-none d-xl-block not appear in mobile [responsive] -->
                <a class="social-icon" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/olivierleung"><i class="fab fa-linkedin-in"></i></a>
                <a class="social-icon" target="_blank" rel="noopener noreferrer" href="https://github.com/SkallZou"><i class="fab fa-github"></i></a>
                <a class="social-icon" target="_blank" rel="noopener noreferrer" href="https://twitter.com/olivier_leung"><i class="fab fa-twitter"></i></a>
            </div>
        <footer class="d-none d-xl-block">
            <div class="container">
              <p class="m-1 text-center footerpage">Copyright &copy; 2021 Olivier Leung<br>All rights reserved.</p>
            </div>
        </footer>
        </nav>
        <!-- Page Content-->
        <div>
            <nav class="navbar navbar-expand-xl navbar-dark bg-header sticky-top">
            <h3 class="header-article"><a href="../malwarepage.html">Malware Analysis </a>> Cyberdefenders - Banking Troubles</h3>
            </nav>
            <section class="article">
                <div class="d-flex flex-column flex-md-row justify-content-between mb-5">
                    <div class="flex-grow-1">
                        <p>

                           The given resource is a .vmem file. Volatility is a tool that can be used to retrieve some crucial information on the memory image. <br>
                           <br>
                           If you are using volatility2, you need to determine the profile used for the memory analysis. 

                           <div class="squarebox">vol.py -f Bob.vmem imageinfo</div>

                           The profile used will be WinXPSP2x86. <br>
                           <br>

                           <h4>What was the local IP address of the victim's machine ?</h4>

                           When analyzing a suspicious system, it is interesting to know if the system is communicating with a suspicious IP address. 
                           <div class="squarebox">vol.py -f Bob.vmem --profile=WinXPSP2x86 connections</div>

                           <img src="img/bankingtroubles/connections.jpg" class="img-fluid" width="600">
                           <br>
                           <h4>What was the OS environment variable's value ?</h4>

                           The function <strong>envars</strong> in volatility displays the environment variable of the system.

                           <div class="squarebox">vol.py -f Bob.vmem --profile=WinXPSP2x86 envars | grep OS</div>


                           <img src="img/bankingtroubles/envars.jpg" class="img-fluid" width="600">

                           <h4>What was the Administrator's password ?</h4>
                           In a Windows system, it exists several registry hives. The ones that interest us to recover the password are the SAM (-s) and the SYSTEM (-y) hives. First we must list the registry hives.

                           <div class="squarebox">vol.py -f Bob.vmem --profile=WinXPSP2x86 hivelist</div>
                           <img src="img/bankingtroubles/hivelist.jpg" class="img-fluid" width="600">

                           The virtual address of the SAM hive is <strong>0xe151ea08</strong> and the virtual address of the system hive is <strong>0xe1035b60</strong>. <br>
                           Now that we have the virtual addresses of the SAM and system hives, we can proceed to the password cracking of the system.

                           <div class="squarebox">vol.py -f Bob.vmem --profile=WinXPSP2x86 hashdump -y 0xe1035b60 -s 0xe151ea08</div>

                           <img src="img/bankingtroubles/hashdump.jpg" class="img-fluid" width="600">

                           <i>Administrator:500:e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c:::</i> <br><br>
                           Here is the structure of the hash : <strong>Username:SID:LMhash:NThash</strong>
                           <br>
                           The difference between LM and NT hashes is that the LMhash is case insensitive while NThash is case sensitive. LMhash support only 142 characters while NThash support 65536 characters. <br>
                           <br>
                           With the retrieved hash, let's use the tool <strong>John the Ripper</strong> to crack it.

                           <div class="squarebox">john --format=NT -w=/usr/share/wordlists/rockyou.txt hash.txt --pot=output.txt</div>

                           <img src="img/bankingtroubles/password.jpg" class="img-fluid" width="600">

                           The administrator's password is "password". <br><br>
                           <h4>Which process was most likely responsible for the initial exploit ?</h4>
                           To look closely to the process running, pslist, pstree can be used to list the running process at the time the memory dump has started.

                           <div class="squarebox">vol.py -f Bob.vmem --profile=WinXPSP2x86 pstree</div>

                           <img src="img/bankingtroubles/pstree.jpg" class="img-fluid" width="600">

                           AcroRd32.exe has been launched by firefox.exe, which shouldn't be the case for a legitimate Acrobat Reader program. <br>
                           <br>
                           The process ID of the AcroRd32.exe is 1752, and its parent process ID is 888. Let's take a look at the remote connection to see if the program is connected to a suspicious IP address.

                           <div class="squarebox">vol.py -f Bob.vmem --profile=WinXPSP2x86 connections | egrep "^Offset|888|1752"</div>

                           Taking a look at the open network connection, we notice that the IP address 212.150.164.203 on the port 80 appear twice with both PIDs.
                           <br><br>
                           <h4>A suspicious URL was present in process svchost.exe memory. Provide the full URL that points to a PHP page hosted over a public IP (no FQDN).</h4>
                           Looking at the open network connection of the system, we see that there is another process ID (880) that remotely communicate with another suspicious IP address.

                           <img src="img/bankingtroubles/connections3.jpg" class="img-fluid" width="600">

                           Listing the processes shows that the PID 880 belongs to a svchost.exe process.

                           <img src="img/bankingtroubles/pslist.jpg" class="img-fluid" width="600">

                           Yarascan is a volatility plugin that scan a memory image for a yara signature. First, let's create a yara rule that will trigger in case of a http/https detection.

                           <div class="squarebox">
                               rule findhttp{ <br>
                                &emsp;meta: <br>
                                &emsp;author="HakkYahud" <br>
                                &emsp;description="Finding malicious http(s)" <br>
                                &emsp;create="09/08/2022" <br>
                                &strings: <br>
                                &emsp;$https="https://" <br>
                                &emsp;$http="http://" <br>
                                &emsp;$php=".php" <br>
                                &emsp;condition: <br>
                                ($https and $php) or ($http and $php)
                               }
                           </div>

                           <div class="squarebox">vol.py -f Bob.vmem --profile=WinXPSP2x86 -y findhttp.yar yarascan -p 880</div>

                           <img src="img/bankingtroubles/yarascan.jpg" class="img-fluid" width="600">

                           The result of the yarascan on the process 880 has found an URL "hxxp[:]//193[.]104[.]22[.]71/~produkt/9j856f_4m9y8urb[.]php". <br><br>

                           <h4>Extract files from the initial process. One file has an MD5 hash ending with "528afe08e437765cc". When was this file first submitted for analysis on VirusTotal?</h4>
                           The initial exploit process is AcroRd32.exe with a PID 1752. To start we will dump this process.

                           <div class="squarebox">vol.py -f Bob.vmem --profile=WinXPSP2x86 memdump -p 1752 -D ./dumps</div>

                           Once the memory dump has been retrieved, foremost is a great tool to extract the content of the memory dump, it will recover the files by looking at the headers, footers and internal datastructure of the memory or disk images.

                           <div class="squarebox">foremost -t pdf 1752.dmp</div>

                           <img src="img/bankingtroubles/foremost.jpg" class="img-fluid" width="600">

                           Foremost found and extracted 7 pdf files. We must find the file that has a hash ending with "528afe08e437765cc".

                           <div class="squarebox">md5sum * | grep 528afe08e437765cc</div>

                           <img src="img/bankingtroubles/md5sum.jpg" class="img-fluid" width="600">

                            <h4>What was the PID of the process that loaded the file PDF.php?</h4>

                            <div class="squarebox">Strings 1752.dmp | grep PDF.php</div>



                        </p>
                    </div>
                </div>
            </section>
        </div>
        <script src="../js/lightbox.js"></script>
        <!-- Bootstrap core JS-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Third party plugin JS-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
    </body>
</html>
